---
title: "ORIE 4630 Final Project: Communication Services"
author: "Benjamin Tang, Ashwin Tayur, Erin Xu"
date: "2024-12-14"
output:
  pdf_document: default
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)
library(dplyr)
library(tidyr)
library(matlib)
library(stats)
library(tseries)
library(quantmod)
library(MASS)
```

```{r}
# between the most popular ETFs tracking the communications sector,
# VOX was the only one that started before 2017
getSymbols("VOX", from = "2017-01-01", to = "2019-12-31")

# these are the top 3 largest holdings in VOX, and also the largest
# companies in the sector
getSymbols("GOOG", from = "2017-01-01", to = "2019-12-31")
getSymbols("META", from = "2017-01-01", to = "2019-12-31")
getSymbols("NFLX", from = "2017-01-01", to = "2019-12-31")

# using the 3-month treasury bill as the risk free rate
DTB3 <- read.csv(paste0("./DTB3.csv"), header = TRUE)
DTB3 <- DTB3[!is.na(DTB3$DTB3),]
```
## Question 1

*Calculate daily returns for your industry for 2017-2019. Download two types
of data for this - the industry level series on Yahoo Finance, and the top 3 or
4 companies in the sector. Justify the ticker choice you made to represent the
industries (e.g., the most famous ones, largest ones, ones you are particularly
curious about, etc.). Plot the cumulative performance of the industry and the
individual assets.*

```{r}
VOX_returns <- dailyReturn(VOX$VOX.Adjusted, type = "arithmetic")[-1]
GOOG_returns <- dailyReturn(GOOG$GOOG.Adjusted, type = "arithmetic")[-1]
META_returns <- dailyReturn(META$META.Adjusted, type = "arithmetic")[-1]
NFLX_returns <- dailyReturn(NFLX$NFLX.Adjusted, type = "arithmetic")[-1]

returns <- merge(VOX_returns, GOOG_returns, META_returns, NFLX_returns)
colnames(returns) <- c("VOX", "GOOG", "META", "NFLX")
head(returns)

VOX_cum <- cumprod(1 + VOX_returns)
GOOG_cum <- cumprod(1 + GOOG_returns)
META_cum <- cumprod(1 + META_returns)
NFLX_cum <- cumprod(1 + NFLX_returns)

plot(index(VOX_cum), VOX_cum, type = "l", col = "black", lwd = 1, 
     xlab = "Date", ylab = "Cumulative Returns", main = "Cumulative Returns", 
     ylim = range(c(VOX_cum, GOOG_cum, META_cum, NFLX_cum), na.rm = TRUE))
lines(index(GOOG_cum), GOOG_cum, col = "green", lwd = 1)
lines(index(META_cum), META_cum, col = "red", lwd = 1)
lines(index(NFLX_cum), NFLX_cum, col = "blue", lwd = 1)
legend("topleft", legend = c("VOX", "GOOG", "META", "NFLX"), 
       col = c("black", "green", "red", "blue"), lty = 1, lwd = 1)
```

## Question 2

*Report summary statistics like mean and sd for daily returns by year and
industry i.e., in two Nx2 table with periods along the columns and assets along
the rows. N denotes the number of assets (i.e., number of individual companies
and the overall series). One table is for reporting mean, the other for sd.*

```{r}
returns_by_year <- split(returns, format(index(returns), "%Y"))

mean_table <- sapply(returns_by_year, function(year_data) colMeans(year_data, na.rm = TRUE))
sd_table <- sapply(returns_by_year, function(year_data) apply(year_data, 2, sd, na.rm = TRUE))

cat("Mean of Daily Returns, by Year (2017-2019):\n")
print(mean_table)
cat("\nStandard Deviation of Daily Returns, by Year (2017-2019):\n")
print(sd_table)
```

## Question 3

*Use techniques we learnt in portfolio optimization to create an optimal portfolio
of the individual companies in your industry. Comment on the riskiness of
the assets, the overall series and your constructed portfolio in the Markowitz
portfolio optimization world (meaning using standard deviations and Sharpe
ratios).*

I am using the 3-month treasury bills as the risk-free rate.
https://fred.stlouisfed.org/series/DTB3

SOFR was only caluclated since 04-2018.

```{r}
mu.vec <- colMeans(returns, na.rm = TRUE)
sd.vec <- apply(returns, 2, sd, na.rm = TRUE)
trading_days <- nrow(returns)
rf_annual <- mean(DTB3$DTB3[DTB3$observation >= as.Date("2017-01-01") & DTB3$observation <= as.Date("2019-12-31")], na.rm = TRUE)
rf <- rf_annual / trading_days / 100
Sigma = cov(returns[,-1])
```

### Calculate the tangency portfolio
```{r}
num = solve(Sigma)%*%(mu.vec[-1]-rf)
den = as.numeric(t(rep(1,3))%*%solve(Sigma)%*%(mu.vec[-1]-rf))
tan.vec = num/den
mu_tan = as.numeric(crossprod(tan.vec, mu.vec[-1]))
sd_tan = sqrt(as.numeric(t(tan.vec)%*%Sigma%*%tan.vec))

tanpf = rbind(mu_tan, sd_tan, tan.vec)
rownames(tanpf) = c("mean", "sd", "GOOG", "META", "NFLX")
colnames(tanpf) = c("tangency pf")

print(round(tanpf,3))

voxpf = rbind(mu.vec[1], sd.vec[1])
rownames(voxpf) = c("mean", "sd")
print(voxpf)
```
### Calculate the Sharpe Ratios
```{r}
top.mat = cbind(2*Sigma, rep(1, 3))
bot.vec = c(rep(1, 3), 0)
Am.mat = rbind(top.mat, bot.vec)
b.vec = c(rep(0, 3), 1)
zm.mat = solve(Am.mat)%*%b.vec
wmin.vec = zm.mat[1:3,1]
mu_min = as.numeric(crossprod(wmin.vec, mu.vec[-1]))
sd_min = sqrt(as.numeric(t(wmin.vec)%*%Sigma%*%wmin.vec))

SR_VOX = (mu.vec[1]-rf)/sd.vec[1]
SR_GOOG = (mu.vec[2]-rf)/sd.vec[2]
SR_META = (mu.vec[3]-rf)/sd.vec[3]
SR_NFLX = (mu.vec[4]-rf)/sd.vec[4]
SR_min = (mu_min-rf)/sd_min
SR_tan = (tanpf[1] - rf)/tanpf[2]
sr = rbind(SR_VOX, SR_GOOG,SR_META, SR_NFLX, SR_min, SR_tan)
rownames(sr) = c("SR_VOX", "SR_GOOG","SR_META", "SR_NFLX", "SR min var", "SR tangency")
colnames(sr) = c("Sharpe Ratios")
round(sr*100,3)
```
### Analysis
Looking at the individuals stocks, we see that Netflix has the highest Sharpe Ratio of 6.368,
and thus has the most attractive risk-adjusted return. However, Google and Meta are not far
behind at 5.411 and 4.881. Thus, the tangential portfolio puts the highest weight on NFLX, but
still a significant proportion in the others. All of them are above 3 and thus very good stocks to invest in.
The Sharpe Ratio of the tangency portfolio is higher than each individual stock, at 6.870. This is much
higher than the Sharpe Ratio of VOX, which is at -0.060.

The tangency porfolio performs quite well, averaging 0.1% growth per trading day but with a
high standard deviation of 1.7%. Compared to the VOX, which averages a much lower 0.002% growth per trading day
and with a smaller standard deviation of 1.0%. VOX is a safer investment for sure, but gives much worse
expected returns, even when adjusted for risk.

# TODO: Make graph (Markowitz bullet), check to make sure my calculations (0.1%, 0.002%, etc. are correct and per day)

## Question 4

*Compare the performance of the pf you constructed to the overall series dur-
ing your sample period, and also over the next 3 years, namely, 2020-2022.
Comment on your findings.*

### 2017-2019
```{r}
tan_returns <- rowSums(returns[,-1] %*% tan.vec, na.rm = TRUE)
tan_cum <- cumprod(1 + tan_returns)

# Convert to time series
VOX_cum <- xts(VOX_cum, order.by = index(VOX_returns))
tan_cum <- xts(tan_cum, order.by = index(returns[,-1]))
```

### 2020-2022
```{r}
# Fetch next 3 years (2020-2022)
VOX_new <- getSymbols("VOX", from = "2020-01-01", to = "2022-12-31", auto.assign = FALSE)
GOOG_new <- getSymbols("GOOG", from = "2020-01-01", to = "2022-12-31", auto.assign = FALSE)
META_new <- getSymbols("META", from = "2020-01-01", to = "2022-12-31", auto.assign = FALSE)
NFLX_new <- getSymbols("NFLX", from = "2020-01-01", to = "2022-12-31", auto.assign = FALSE)

VOX_returns_2020 <- dailyReturn(VOX_new$VOX.Adjusted, type = "arithmetic")[-1]
GOOG_returns_2020 <- dailyReturn(GOOG_new$GOOG.Adjusted, type = "arithmetic")[-1]
META_returns_2020 <- dailyReturn(META_new$META.Adjusted, type = "arithmetic")[-1]
NFLX_returns_2020 <- dailyReturn(NFLX_new$NFLX.Adjusted, type = "arithmetic")[-1]

returns_2020 <- merge(GOOG_returns_2020, META_returns_2020, NFLX_returns_2020)
colnames(returns_2020) <- c("GOOG", "META", "NFLX")
tan_returns_2020 <- rowSums(returns_2020 %*% tan.vec, na.rm = TRUE)

# Calculate cumulative returns
VOX_cum_2020 <- cumprod(1 + VOX_returns_2020)
tan_cum_2020 <- cumprod(1 + tan_returns_2020)

# Convert to time series
VOX_cum_2020 <- xts(VOX_cum_2020, order.by = index(VOX_returns_2020))
tan_cum_2020 <- xts(tan_cum_2020, order.by = index(returns_2020))
```

### Plots
```{r}
# Plot for 2017-2019
plot(index(VOX_cum), VOX_cum, type = "l", col = "black", lwd = 1, 
     xlab = "Date", ylab = "Cumulative Returns", main = "Cumulative Returns (2017-2019)", 
     ylim = range(c(VOX_cum, tan_cum), na.rm = TRUE))
lines(index(tan_cum), tan_cum, col = "blue", lwd = 1)
legend("topleft", legend = c("VOX", "Tangency Portfolio"), 
       col = c("black", "blue"), lty = 1, lwd = 1)

# Plot for 2020-2022
plot(index(VOX_cum_2020), VOX_cum_2020, type = "l", col = "black", lwd = 1, 
     xlab = "Date", ylab = "Cumulative Returns", main = "Cumulative Returns (2020-2022)", 
     ylim = range(c(VOX_cum_2020, tan_cum_2020), na.rm = TRUE))
lines(index(tan_cum_2020), tan_cum_2020, col = "blue", lwd = 1)
legend("topleft", legend = c("VOX", "Tangency Portfolio"), 
       col = c("black", "blue"), lty = 1, lwd = 1)
```

### Analysis

Looking at the plots above, we found that the cumulative returns for our portfolio
performs much better than VOX in 2017-2019, confirming our expectations from the previous
question. However, in 2020-2022, the tangency portfolio seems to outperform VOX somewhat
until the end of 2021, from which it performs worse. By the end of 2022, the cumulative
returns for our portfolio and VOX end up to be approximately the same.

# TODO: Is this sufficient? Might be useful to analyze excess returns or sharpe ratios (?)
